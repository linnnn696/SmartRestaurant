export type ResourceStr = Resource | string;

// å®šä¹‰äº‹ä»¶æ•°æ®ç±»å‹
interface CartEventData {
  type: 'cart-updated';
}

type EventData = CartEventData | void;
type EventCallback = (data?: EventData) => void;

// æ·»åŠ äº‹ä»¶æ€»çº¿ç±»
class EventBus {
  private static instance: EventBus;
  private listeners: Map<string, EventCallback[]>;

  private constructor() {
    this.listeners = new Map<string, EventCallback[]>();
  }

  static getInstance(): EventBus {
    if (!EventBus.instance) {
      EventBus.instance = new EventBus();
    }
    return EventBus.instance;
  }

  on(event: string, callback: EventCallback): void {
    const callbacks = this.listeners.get(event) || [];
    if (!this.listeners.has(event)) {
      this.listeners.set(event, callbacks);
    }
    callbacks.push(callback);
  }

  off(event: string, callback: EventCallback): void {
    const callbacks = this.listeners.get(event);
    if (callbacks) {
      const index = callbacks.indexOf(callback);
      if (index > -1) {
        callbacks.splice(index, 1);
      }
    }
  }

  emit(event: string, data?: EventData): void {
    const callbacks = this.listeners.get(event);
    if (callbacks) {
      callbacks.forEach((callback: EventCallback) => callback(data));
    }
  }
}

export const eventBus = EventBus.getInstance();

export interface DishItem {
  id: string;
  name: string;
  price: number;
  description: string;
  image: ResourceStr;
  category: string;
  sales?: number;
  isSpicy?: boolean;
  tag?: string;
}

export interface CategoryItem {
  id: string;
  name: string;
  icon: string;
}

export const DISH_CATEGORIES: CategoryItem[] = [
  { id: 'hot', name: 'çƒ­èœ', icon: 'ğŸ”¥' },
  { id: 'cold', name: 'å‡‰èœ', icon: 'â„ï¸' },
  { id: 'staple', name: 'ä¸»é£Ÿ', icon: 'ğŸš' },
  { id: 'soup', name: 'æ±¤å“', icon: 'ğŸ¥£' },
  { id: 'drink', name: 'é¥®å“', icon: 'ğŸ¥¤' }
];

export class CartItem {
  dishId: string;
  quantity: number;

  constructor(dishId: string, quantity: number = 1) {
    this.dishId = dishId;
    this.quantity = quantity;
  }
}

export const SAMPLE_DISHES: DishItem[] = [
  // çƒ­èœ
  {
    id: '1',  // å®«ä¿é¸¡ä¸
    name: 'å®«ä¿é¸¡ä¸',
    price: 38.00,
    description: 'ç»å…¸å·èœï¼Œå£æ„Ÿéº»è¾£é²œé¦™',
    image: $r('app.media.gongbao_chicken'),
    category: 'çƒ­èœ',
    tag: 'æ‹›ç‰Œ',
    sales: 238
  },
  {
    id: '2',  // æ°´ç…®é±¼ç‰‡
    name: 'æ°´ç…®é±¼ç‰‡',
    price: 58.00,
    description: 'æ–°é²œè‰é±¼ç‰‡ï¼Œéº»è¾£é²œé¦™',
    image: $r('app.media.fish_dish'),
    category: 'çƒ­èœ',
    tag: 'ç‰¹è‰²',
    sales: 186
  },
  {
    id: '3',  // åŒ—äº¬çƒ¤é¸­
    name: 'åŒ—äº¬çƒ¤é¸­',
    price: 108.00,
    description: 'å¤–é…¥é‡Œå«©ï¼Œæ­é…ç‰¹åˆ¶é…±æ–™',
    image: $r('app.media.roasted_duck'),
    category: 'çƒ­èœ',
    tag: 'æ¨è',
    sales: 156
  },
  {
    id: '4',  // è’œè“‰ç²‰ä¸æ‰‡è´
    name: 'è’œè“‰ç²‰ä¸æ‰‡è´',
    price: 48.00,
    description: 'æ–°é²œæ‰‡è´ï¼Œè’œé¦™æµ“éƒ',
    image: $r('app.media.scallop_dish'),
    category: 'çƒ­èœ',
    tag: 'æ–°å“',
    sales: 92
  },
  {
    id: '5',  // é’æ¤’ç‚’è‚‰
    name: 'é’æ¤’ç‚’è‚‰',
    price: 32.00,
    description: 'å†œå®¶å°ç‚’ï¼Œä¸‹é¥­é¦–é€‰',
    image: $r('app.media.pork_dish'),
    category: 'çƒ­èœ',
    sales: 165
  },
  {
    id: '6',  // ç´ ç‚’ä»€é”¦
    name: 'ç´ ç‚’ä»€é”¦',
    price: 28.00,
    description: 'è¥å…»æ­é…ï¼Œæ¸…æ·¡çˆ½å£',
    image: $r('app.media.mixed_veggies'),
    category: 'çƒ­èœ',
    sales: 145
  },
  {
    id: '7',  // é±¼é¦™è‚‰ä¸
    name: 'é±¼é¦™è‚‰ä¸',
    price: 36.00,
    description: 'ä¼ ç»Ÿå·èœï¼Œé…¸ç”œå¯å£',
    image: $r('app.media.yuxiang_pork'),
    category: 'çƒ­èœ',
    tag: 'ç‰¹è‰²',
    sales: 198
  },
  {
    id: '8',  // éº»å©†è±†è…
    name: 'éº»å©†è±†è…',
    price: 28.00,
    description: 'å·èœä»£è¡¨ï¼Œéº»è¾£é²œé¦™',
    image: $r('app.media.mapo_tofu'),
    category: 'çƒ­èœ',
    tag: 'æ¨è',
    sales: 178
  },

  // å‡‰èœ
  {
    id: '9',  // å‡‰æ‹Œé»„ç“œ
    name: 'å‡‰æ‹Œé»„ç“œ',
    price: 18.00,
    description: 'æ¸…è„†çˆ½å£ï¼Œå¼€èƒƒè§£è…»',
    image: $r('app.media.cucumber_salad'),
    category: 'å‡‰èœ',
    sales: 135
  },
  {
    id: '10',  // å‡‰æ‹Œæœ¨è€³
    name: 'å‡‰æ‹Œæœ¨è€³',
    price: 22.00,
    description: 'çˆ½æ»‘å¯å£ï¼Œè¥å…»ä¸°å¯Œ',
    image: $r('app.media.black_fungus'),
    category: 'å‡‰èœ',
    sales: 122
  },
  {
    id: '11',  // å£æ°´é¸¡
    name: 'å£æ°´é¸¡',
    price: 36.00,
    description: 'å·å¼å‡‰èœï¼Œéº»è¾£çˆ½å£',
    image: $r('app.media.saliva_chicken'),
    category: 'å‡‰èœ',
    tag: 'ç‰¹è‰²',
    sales: 168
  },
  {
    id: '12',  // ç™½åˆ‡é¸¡
    name: 'ç™½åˆ‡é¸¡',
    price: 48.00,
    description: 'é²œå«©å¤šæ±ï¼Œé…å§œè‘±é…±',
    image: $r('app.media.white_cut_chicken'),
    category: 'å‡‰èœ',
    tag: 'æ¨è',
    sales: 145
  },
  {
    id: '13',  // çš®è›‹è±†è…
    name: 'çš®è›‹è±†è…',
    price: 22.00,
    description: 'ç»å…¸æ­é…ï¼Œè¥å…»ç¾å‘³',
    image: $r('app.media.tofu_egg'),
    category: 'å‡‰èœ',
    sales: 156
  },

  // ä¸»é£Ÿ
  {
    id: '14',  // æ‰¬å·ç‚’é¥­
    name: 'æ‰¬å·ç‚’é¥­',
    price: 28.00,
    description: 'è‰²é¦™å‘³ä¿±å…¨ï¼Œæ–™è¶³å‘³ç¾',
    image: $r('app.media.yangzhou_rice'),
    category: 'ä¸»é£Ÿ',
    tag: 'æ‹›ç‰Œ',
    sales: 245
  },
  {
    id: '15',  // é˜³æ˜¥é¢
    name: 'é˜³æ˜¥é¢',
    price: 18.00,
    description: 'æ±¤é²œé¢æ»‘ï¼Œç»å…¸å¥½å‘³',
    image: $r('app.media.plain_noodles'),
    category: 'ä¸»é£Ÿ',
    sales: 178
  },
  {
    id: '16',  // è’¸åŒ…å­
    name: 'è’¸åŒ…å­',
    price: 12.00,
    description: 'çš®è–„é¦…å¤§ï¼Œç°è’¸ç°å–',
    image: $r('app.media.steamed_bun'),
    category: 'ä¸»é£Ÿ',
    sales: 198
  },
  {
    id: '17',  // å’Œç‰›ç‚’é¥­
    name: 'å’Œç‰›ç‚’é¥­',
    price: 88.00,
    description: 'é¡¶çº§é£Ÿæï¼Œå…¥å£å³åŒ–',
    image: $r('app.media.wagyu_rice'),
    category: 'ä¸»é£Ÿ',
    tag: 'æ–°å“',
    sales: 68
  },
  {
    id: '18',  // æ¾éœ²ç‚’é¥­
    name: 'æ¾éœ²ç‚’é¥­',
    price: 48.00,
    description: 'å¥¢åæ–°å“ï¼Œæ¾éœ²é£˜é¦™',
    image: $r('app.media.truffle_rice'),
    category: 'ä¸»é£Ÿ',
    tag: 'æ–°å“',
    sales: 86
  },
  {
    id: '19',  // è›‹ç‚’é¥­
    name: 'è›‹ç‚’é¥­',
    price: 16.00,
    description: 'ç²’ç²’åˆ†æ˜ï¼Œé¦™æ°”æ‰‘é¼»',
    image: $r('app.media.egg_rice'),
    category: 'ä¸»é£Ÿ',
    tag: 'æ¨è',
    sales: 256
  },

  // æ±¤å“
  {
    id: '20',  // ä¾‹æ±¤
    name: 'ä¾‹æ±¤',
    price: 8.00,
    description: 'æ¯æ—¥æ–°é²œç†¬åˆ¶ï¼Œæ»‹è¡¥å…»ç”Ÿ',
    image: $r('app.media.soup_dish'),
    category: 'æ±¤å“',
    sales: 320
  },
  {
    id: '21',  // ç•ªèŒ„è›‹æ±¤
    name: 'ç•ªèŒ„è›‹æ±¤',
    price: 20.00,
    description: 'å®¶å¸¸ç¾å‘³ï¼Œè¥å…»å¥åº·',
    image: $r('app.media.tomato_soup'),
    category: 'æ±¤å“',
    sales: 168
  },
  {
    id: '22',  // ç´«èœè›‹èŠ±æ±¤
    name: 'ç´«èœè›‹èŠ±æ±¤',
    price: 20.00,
    description: 'æ¸…æ·¡å…»ç”Ÿï¼Œå¼€èƒƒæš–èº«',
    image: $r('app.media.seaweed_soup'),
    category: 'æ±¤å“',
    sales: 145
  },

  // é¥®å“
  {
    id: '23',  // æŸ æª¬æ°´
    name: 'æŸ æª¬æ°´',
    price: 12.00,
    description: 'æ¸…æ–°æŸ æª¬ï¼Œå†°é•‡æç¥',
    image: $r('app.media.lemon_water'),
    category: 'é¥®å“',
    sales: 178
  },
  {
    id: '24',  // èŒ‰è‰èŠ±èŒ¶
    name: 'èŒ‰è‰èŠ±èŒ¶',
    price: 8.00,
    description: 'èŒ‰è‰é£˜é¦™ï¼Œå›ç”˜æ‚ é•¿',
    image: $r('app.media.jasmine_tea'),
    category: 'é¥®å“',
    sales: 156
  },
  {
    id: '25',  // é›ªç¢§
    name: 'é›ªç¢§',
    price: 6.00,
    description: 'å†°é•‡é›ªç¢§ï¼Œé€å¿ƒå‡‰',
    image: $r('app.media.sprite'),
    category: 'é¥®å“',
    sales: 198
  },
  {
    id: '26',  // å¯ä¹
    name: 'å¯ä¹',
    price: 6.00,
    description: 'å†°é•‡å¯ä¹ï¼Œç•…å¿«çˆ½å£',
    image: $r('app.media.cola'),
    category: 'é¥®å“',
    sales: 245
  }
];

export class CartModel {
  private static instance: CartModel;
  private items: Map<string, CartItem>;

  private constructor() {
    this.items = new Map<string, CartItem>();
  }

  static getInstance(): CartModel {
    if (!CartModel.instance) {
      CartModel.instance = new CartModel();
    }
    return CartModel.instance;
  }

  addToCart(dishId: string): void {
    // å…ˆéªŒè¯èœå“æ˜¯å¦å­˜åœ¨
    const dish = SAMPLE_DISHES.find(d => d.id === dishId);
    if (!dish) {
      console.error('æ·»åŠ åˆ°è´­ç‰©è½¦å¤±è´¥ï¼šæ‰¾ä¸åˆ°èœå“', dishId);
      return;
    }

    const item = this.items.get(dishId);
    if (item) {
      item.quantity += 1;
    } else {
      this.items.set(dishId, new CartItem(dishId));
    }
    eventBus.emit('cart-updated');
  }

  removeFromCart(dishId: string): void {
    // å…ˆéªŒè¯èœå“æ˜¯å¦å­˜åœ¨
    const dish = SAMPLE_DISHES.find(d => d.id === dishId);
    if (!dish) {
      console.error('ä»è´­ç‰©è½¦ç§»é™¤å¤±è´¥ï¼šæ‰¾ä¸åˆ°èœå“', dishId);
      return;
    }

    const item = this.items.get(dishId);
    if (item) {
      if (item.quantity > 1) {
        item.quantity -= 1;
      } else {
        this.items.delete(dishId);
      }
      eventBus.emit('cart-updated');
    }
  }

  getItemCount(dishId: string): number {
    const item = this.items.get(dishId);
    return item ? item.quantity : 0;
  }

  getTotalCount(): number {
    let total = 0;
    this.items.forEach(item => total += item.quantity);
    return total;
  }

  getTotalAmount(): number {
    let total = 0;
    this.items.forEach(item => {
      const dish = SAMPLE_DISHES.find(d => d.id === item.dishId);
      if (dish) {
        total += dish.price * item.quantity;
      } else {
        console.error('è®¡ç®—æ€»ä»·å¤±è´¥ï¼šæ‰¾ä¸åˆ°èœå“', item.dishId);
      }
    });
    return total;
  }

  getItems(): CartItem[] {
    return Array.from(this.items.values());
  }

  clearCart(): void {
    this.items.clear();
    eventBus.emit('cart-updated');
  }
} 