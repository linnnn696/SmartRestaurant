export type ResourceStr = Resource | string;

// å®šä¹‰äº‹ä»¶æ•°æ®ç±»å‹
interface CartEventData {
  type: 'cart-updated';
}

type EventData = CartEventData | void;
type EventCallback = (data?: EventData) => void;

// æ·»åŠ äº‹ä»¶æ€»çº¿ç±»
class EventBus {
  private static instance: EventBus;
  private listeners: Map<string, EventCallback[]>;

  private constructor() {
    this.listeners = new Map<string, EventCallback[]>();
  }

  static getInstance(): EventBus {
    if (!EventBus.instance) {
      EventBus.instance = new EventBus();
    }
    return EventBus.instance;
  }

  on(event: string, callback: EventCallback): void {
    const callbacks = this.listeners.get(event) || [];
    if (!this.listeners.has(event)) {
      this.listeners.set(event, callbacks);
    }
    callbacks.push(callback);
  }

  off(event: string, callback: EventCallback): void {
    const callbacks = this.listeners.get(event);
    if (callbacks) {
      const index = callbacks.indexOf(callback);
      if (index > -1) {
        callbacks.splice(index, 1);
      }
    }
  }

  emit(event: string, data?: EventData): void {
    const callbacks = this.listeners.get(event);
    if (callbacks) {
      callbacks.forEach((callback: EventCallback) => callback(data));
    }
  }
}

export const eventBus = EventBus.getInstance();

export interface DishItem {
  id: number;
  name: string;
  price: number;
  description: string;
  image: ResourceStr;
  category: string;
  sales?: number;
  isSpicy?: boolean;
  tag?: string;
}

export interface CategoryItem {
  id: string;
  name: string;
  icon: string;
}

export const DISH_CATEGORIES: CategoryItem[] = [
  { id: 'hot', name: 'çƒ­èœ', icon: 'ğŸ”¥' },
  { id: 'cold', name: 'å‡‰èœ', icon: 'â„ï¸' },
  { id: 'staple', name: 'ä¸»é£Ÿ', icon: 'ğŸš' },
  { id: 'soup', name: 'æ±¤ç±»', icon: 'ğŸ¥£' },
  { id: 'drink', name: 'é¥®å“', icon: 'ğŸ¥¤' }
];

export class CartItem {
  dishId: number;
  quantity: number;

  constructor(dishId: number, quantity: number = 1) {
    this.dishId = dishId;
    this.quantity = quantity;
  }
}

export const SAMPLE_DISHES: DishItem[] = [
  {
    id: 1,
    name: 'å®«ä¿é¸¡ä¸',
    price: 38.00,
    description: 'ç»å…¸å·èœï¼Œå£æ„Ÿéº»è¾£é²œé¦™',
    image: $r('app.media.dish_kungpao'),
    category: 'çƒ­èœ',
    sales: 100,
    isSpicy: true,
    tag: 'æ‹›ç‰Œ'
  },
  {
    id: 2,
    name: 'æ°´ç…®é±¼ç‰‡',
    price: 58.00,
    description: 'æ–°é²œè‰é±¼ç‰‡ï¼Œéº»è¾£é²œé¦™',
    image: $r('app.media.dish_fish'),
    category: 'çƒ­èœ',
    sales: 88,
    isSpicy: true,
    tag: 'ç‰¹è‰²'
  },
  {
    id: 3,
    name: 'åŒ—äº¬çƒ¤é¸­',
    price: 108.00,
    description: 'å¤–é…¥é‡Œå«©ï¼Œæ­é…ç‰¹åˆ¶é…±æ–™',
    image: $r('app.media.dish_duck'),
    category: 'çƒ­èœ',
    sales: 50,
    tag: 'æ¨è'
  },
  {
    id: 4,
    name: 'è’œè“‰ç²‰ä¸æ‰‡è´',
    price: 48.00,
    description: 'æ–°é²œæ‰‡è´ï¼Œè’œé¦™æµ“éƒ',
    image: $r('app.media.dish_scallop'),
    category: 'çƒ­èœ',
    sales: 45,
    tag: 'æ–°å“'
  },
  {
    id: 5,
    name: 'é’æ¤’ç‚’è‚‰',
    price: 32.00,
    description: 'å†œå®¶å°ç‚’ï¼Œä¸‹é¥­é¦–é€‰',
    image: $r('app.media.dish_pork'),
    category: 'çƒ­èœ',
    sales: 80
  },
  {
    id: 6,
    name: 'å‡‰æ‹Œé»„ç“œ',
    price: 18.00,
    description: 'æ¸…è„†çˆ½å£ï¼Œå¼€èƒƒè§£è…»',
    image: '#90EE90',
    category: 'å‡‰èœ',
    sales: 60
  },
  {
    id: 7,
    name: 'å‡‰æ‹Œæœ¨è€³',
    price: 22.00,
    description: 'çˆ½æ»‘å¯å£ï¼Œè¥å…»ä¸°å¯Œ',
    image: '#2F4F4F',
    category: 'å‡‰èœ',
    sales: 40
  },
  {
    id: 8,
    name: 'ç™½åˆ‡é¸¡',
    price: 48.00,
    description: 'é²œå«©å¤šæ±ï¼Œé…å§œè‘±é…±',
    image: '#F5DEB3',
    category: 'å‡‰èœ',
    sales: 75
  },
  {
    id: 9,
    name: 'æ‰¬å·ç‚’é¥­',
    price: 28.00,
    description: 'è‰²é¦™å‘³ä¿±å…¨ï¼Œæ–™è¶³å‘³ç¾',
    image: '#FFE4B5',
    category: 'ä¸»é£Ÿ',
    sales: 120
  },
  {
    id: 10,
    name: 'é˜³æ˜¥é¢',
    price: 18.00,
    description: 'æ±¤é²œé¢æ»‘ï¼Œç»å…¸å¥½å‘³',
    image: '#FFF8DC',
    category: 'ä¸»é£Ÿ',
    sales: 90
  },
  {
    id: 11,
    name: 'è’¸é¥º',
    price: 25.00,
    description: 'çš®è–„é¦…å¤§ï¼Œé²œé¦™å¯å£',
    image: '#F0F8FF',
    category: 'ä¸»é£Ÿ',
    sales: 85
  },
  {
    id: 12,
    name: 'è¥¿æ¹–ç‰›è‚‰ç¾¹',
    price: 32.00,
    description: 'æµ“éƒé²œç¾ï¼Œè¥å…»ä¸°å¯Œ',
    image: '#8B4513',
    category: 'æ±¤ç±»',
    sales: 55
  },
  {
    id: 13,
    name: 'ç´«èœè›‹èŠ±æ±¤',
    price: 20.00,
    description: 'æ¸…æ·¡çˆ½å£ï¼Œå¼€èƒƒè§£è…»',
    image: '#556B2F',
    category: 'æ±¤ç±»',
    sales: 70
  },
  {
    id: 14,
    name: 'é…¸æ¢…æ±¤',
    price: 15.00,
    description: 'é…¸ç”œå¯å£ï¼Œè§£æš‘é™ç«',
    image: $r('app.media.dish_soup'),
    category: 'é¥®å“',
    sales: 100,
    tag: 'æ¨è'
  },
  {
    id: 15,
    name: 'æŸ æª¬èœ‚èœœæ°´',
    price: 18.00,
    description: 'æ¸…æ–°æ¶¦å–‰ï¼Œç¾å®¹å…»é¢œ',
    image: $r('app.media.dish_soup'),
    category: 'é¥®å“',
    sales: 80
  },
  {
    id: 16,
    name: 'èŠ’æœæ±',
    price: 16.00,
    description: 'æ–°é²œèŠ’æœåˆ¶ä½œï¼Œé¦™ç”œå¯å£',
    image: $r('app.media.dish_soup'),
    category: 'é¥®å“',
    sales: 90,
    tag: 'æ–°å“'
  },
  {
    id: 17,
    name: 'çç å¥¶èŒ¶',
    price: 18.00,
    description: 'é¦™æµ“å¥¶èŒ¶ï¼Œå¼¹æ€§çç ',
    image: $r('app.media.dish_soup'),
    category: 'é¥®å“',
    sales: 120,
    tag: 'çƒ­é”€'
  }
];

export class CartModel {
  private static instance: CartModel;
  private items: Map<number, CartItem> = new Map();

  private constructor() {}

  static getInstance(): CartModel {
    if (!CartModel.instance) {
      CartModel.instance = new CartModel();
    }
    return CartModel.instance;
  }

  addToCart(dishId: number): void {
    const item = this.items.get(dishId);
    if (item) {
      item.quantity += 1;
    } else {
      this.items.set(dishId, new CartItem(dishId));
    }
    eventBus.emit('cart-updated');
  }

  removeFromCart(dishId: number): void {
    const item = this.items.get(dishId);
    if (item) {
      if (item.quantity > 1) {
        item.quantity -= 1;
      } else {
        this.items.delete(dishId);
      }
      eventBus.emit('cart-updated');
    }
  }

  getItemCount(dishId: number): number {
    return this.items.get(dishId)?.quantity || 0;
  }

  getTotalCount(): number {
    let total = 0;
    this.items.forEach(item => total += item.quantity);
    return total;
  }

  getTotalAmount(): number {
    let total = 0;
    this.items.forEach(item => {
      const dish = SAMPLE_DISHES.find(d => d.id === item.dishId);
      if (dish) {
        total += dish.price * item.quantity;
      }
    });
    return total;
  }

  getItems(): CartItem[] {
    return Array.from(this.items.values());
  }

  clearCart(): void {
    this.items.clear();
    eventBus.emit('cart-updated');
  }
} 